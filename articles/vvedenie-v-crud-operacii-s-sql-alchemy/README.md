# Работа с SQLAlchemy и SQLite3: Как стать SQL-магом CRUD-школы

![Разбираемся в серверном и клиентском рендеринге](cover.jpg)

> Автор: Дмитрий Орешин

Привет, дорогой читатель! Добро пожаловать в удивительный мир Python, где с помощью нескольких заклинаний (читай — команд) ты можешь вызвать волшебные сущности из базы данных!

Меня зовут Дмитрий Орешин, и сегодня я буду вашим профессором по магии CRUD-школы, основной дисциплине каждого SQL-мага (от англ. Structured Query Language — язык структурированных запросов).

CRUD, как вы, возможно, знаете, это не новый вид супа, а акроним, обозначающий основные операции работы с базой данных:

- Создание (Create),
- Чтение (Read),
- Обновление (Update)
- Удаление (Delete).

А SQLAlchemy — это не что иное, как ваша магическая палочка, которая поможет сделать все эти операции легкими и эффективными.

Так что, держите ваши палочки (или, скорее, клавиатуры) наготове, и начнем!

## 1. Подготовка к волшебству: необходимые ингредиенты:

Прежде всего, нам понадобятся несколько магических ингредиентов (или, как их ещё называют, библиотек):

```
$ pip install sqlalchemy sqlite
```

Это как порошок флу, но для вашего кода. Одно мгновение и вы уже в мире баз данных!

## 2. Создание мгического свитка (модель данных):

В каждой магической школе есть свои свитки, на которых записаны заклинания. В нашем мире программирования такими «свитками» являются таблицы в базах данных. И эти таблицы определяют структуру и вид данных, которые мы хотим хранить.

Теперь давайте разберем «волшебные ритуалы», которые мы используем для создания такого свитка:

**Импортирование необходимых модулей:**

```
from sqlalchemy import Column, Integer, String, Sequence
from sqlalchemy.ext.declarative import declarative_base

```

Здесь мы импортируем инструменты из **SQLAlchemy**, которые позволят нам создать таблицу в базе данных.

- `create_engine` для подключения к базе данных,
- `Column` для определения столбцов в таблице,
- `Integer` и `String` для определения типов данных,
- А `Sequence` — это специальный инструмент, предназначенный для создания уникальных, автоматически увеличивающихся идентификаторов. При добавлении новой записи в таблицу, Sequence генерирует уникальное значение, которое на единицу превышает предыдущее, гарантируя тем самым, что каждая запись будет иметь уникальный идентификатор.

**Определение базовой декларации:**

```
Base = declarative_base()
```

Этот код создает класс Base, который будет служить основой для всех наших моделей данных. С его помощью мы можем создавать и работать с таблицами базы данных.

**Создание модели `User`:**

```
class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, Sequence('user_id_seq'), primary_key=True)
    name = Column(String(50))
    age = Column(Integer)

```

Теперь мы определяем нашу модель данных, называемую `User`. Она представляет таблицу `users` со следующими столбцами:

- `id`: Идентификатор пользователя. Это уникальный номер, который автоматически увеличивается при добавлении нового пользователя.
- `name`: Столбец для хранения имени пользователя с максимальной длиной 50 символов.
- `age`: Столбец для хранения возраста пользователя в виде числа (не делайте так в реальных проектах — лучше хранить дату рождения, а возраст высчитывать динамически).

## 3. Заклинание создания базы данных:

Теперь, когда у нас есть свиток, нужно место, чтобы хранить наши заклинания:

```
engine = create_engine('sqlite:///users.db')  # Заклинание призыва базы данных
Base.metadata.create_all(engine)  # И вуаля! Таблица 'users' готова к использованию!

```

Не забываем импортировать магию в нашу волшебную палочку:

```
from sqlalchemy import Column, Integer, String, Sequence, create_engine
from sqlalchemy.ext.declarative import declarative_base

```

## 4. Волшебные действия: CRUD-операции

Прежде чем погрузиться в наши волшебные заклинания, давайте разберемся с одной из основных концепций в работе с базами данных — CRUD.

CRUD — это акроним, который обозначает четыре основные операции, выполняемые над данными:

- **C (Create) — Создание**: Это процесс добавления новых данных в базу. Как если бы вы создавали новое волшебное зелье или предмет.
- **R (Read) — Чтение**: После того как данные добавлены в базу, вы можете запросить их для просмотра. Это можно сравнить с чтением древнего свитка или книги заклинаний.
- **U (Update) — Обновление**: С течением времени некоторая информация может стать устаревшей или неактуальной. Обновление данных позволяет внести изменения в уже существующие записи. Это похоже на модификацию заклинания или улучшение рецепта зелья.
- **D (Delete) — Удаление**: Иногда некоторые данные становятся ненужными или их нужно убрать из базы. Удаление позволяет избавиться от этих данных. Это можно сравнить с рассеиванием волшебного тумана или уничтожением опасного артефакта.

Теперь, когда вы знаете основы CRUD, давайте перейдем к нашим волшебным заклинаниям, которые помогут вам освоить каждую из этих операций в мире SQLAlchemy!

### C.  Заклинание призыва (создание записи)

```
from sqlalchemy.orm import sessionmaker

Session = sessionmaker(bind=engine)
session = Session()

new_user = User(name='Merlin', age=500)  # Да-да, именно он!
session.add(new_user)
session.commit()

```

### R. Магия прорицания (чтение данных)

```
users = session.query(User).all()
for user in users:
    print(f"Приветствую, {user.name}! Тебе {user.age} лет? Как ты выглядишь таким молодым?")

```

### U. Заклинание преобразования (обновление данных)

```
merlin = session.query(User).filter_by(name='Merlin').first()
merlin.age = 501  # Ну, время идёт...
session.commit()

```

### D. Заклинание исчезновения (удаление данных)

```
unlucky_wizard = session.query(User).filter_by(name='Merlin').first()
session.delete(unlucky_wizard)  # Прощай, дорогой друг. Надеюсь, ты вернешься в другой базе данных.
session.commit()

```

## Заключение

Таким волшебным образом, при помощи SQLAlchemy и вашего таланта, мы освоили основы магии CRUD-школы. Не забывайте практиковаться, и вскоре вы сможете колдовать на уровне с профессором Дамблдором... или хотя бы с вашим локальным администратором баз данных.
